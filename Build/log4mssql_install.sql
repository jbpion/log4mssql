/*
MIT License

Copyright (c) 2017 jbpion

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/

SET NOCOUNT ON;

DECLARE @Message NVARCHAR(MAX);SELECT @Message = CONCAT(CONVERT(NVARCHAR,GETDATE(),121),':Installation started'); RAISERROR(@Message,0,1);
GO

IF ServerProperty('EngineEdition') <> 5
BEGIN
	DECLARE @Message NVARCHAR(MAX);SELECT @Message = CONCAT(CONVERT(NVARCHAR,GETDATE(),121),':Enabling the CLR for the current database'); RAISERROR(@Message,0,1);
	EXEC sp_configure 'clr enabled', 1;

	SELECT @Message = 'Running the reconfigure command'; RAISERROR(@Message,0,1);
	RECONFIGURE;
END
ELSE
BEGIN
	SELECT @Message = CONCAT(CONVERT(NVARCHAR,GETDATE(),121),':Install is running in Azure. Skipping CLR configuration.'); RAISERROR(@Message,0,1);
END
GO

IF ServerProperty('EngineEdition') <> 5
BEGIN     
	DECLARE @Message NVARCHAR(MAX);SELECT @Message = CONCAT(CONVERT(NVARCHAR,GETDATE(),121),':Setting TRUSTWORTHY on for current database to run CLR stored procedures and functions.'); RAISERROR(@Message,0,1); 
	ALTER DATABASE CURRENT SET TRUSTWORTHY ON
END
GO
GO
CREATE SCHEMA Logger
GO
CREATE SCHEMA LoggerBase
GO

      /*NOTE: This file is automatically generated by the build process. Modifications will be lost.*/
      IF  EXISTS (SELECT * FROM sys.assemblies asms WHERE asms.name = N'log4mssql' and is_user_defined = 1)
      DROP ASSEMBLY [log4mssql]
      GO
      
      CREATE ASSEMBLY [log4mssql]
      FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010300EDE6335A0000000000000000E00002210B0108000014000000060000000000009E3300000020000000400000000040000020000000020000040000000000000004000000000000000080000000020000000000000300408500001000001000000000100000100000000000001000000000000000000000004833000053000000004000001803000000000000000000000000000000000000006000000C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000A4130000002000000014000000020000000000000000000000000000200000602E7273726300000018030000004000000004000000160000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001A0000000000000000000000000000400000420000000000000000000000000000000080330000000000004800000002000500F0250000580D000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001B300400470300000100001100730500000A0A0F01280600000A0B0F00280600000A7201000070280700000A0C730800000A0D09046F0900000A6F0A00000A0000096F0B00000A6F0C00000A130A38D7010000110A6F0D00000A740E0000011304000011046F0B00000A6F0C00000A130B3883010000110B6F0D00000A740E00000113050011056F0E00000A14FE0116FE01130C110C2D0600385B0100000F04280F00000A11056F0E00000A721F0000706F1000000A14FE0116FE015F16FE01130C110C2D3400281100000A723B00007011056F0E00000A721F0000706F1000000A6F1200000A11056F1300000A281400000A6F1500000A000011056F0E00000A721F0000706F1000000A14FE01130C110C3AE100000000066F1600000A1306110611056F0E00000A721F0000706F1000000A6F1200000A6F1700000A0011056F0E00000A729F0000706F1000000A14FE01130C110C2D34001106D017000001281800000A11056F0E00000A729F0000706F1000000A6F1200000A281900000AA5170000016F1A00000A000011056F0E00000A72AD0000706F1000000A14FE01130C110C2D340011056F0E00000A72AD0000706F1000000A6F1200000A1207281B00000A16FE01130C110C2D0C00110611076F1C00000A000000110611056F1300000A6F1D00000A00066F1E00000A11066F1F00000A260000110B6F2000000A130C110C3A6DFEFFFFDE1D110B751D000001130D110D14FE01130C110C2D08110D6F2100000A00DC0000110A6F2000000A130C110C3A19FEFFFFDE1D110A751D000001130D110D14FE01130C110C2D08110D6F2100000A00DC0008732200000A13080011086F2300000A0006176F2400000A0006076F2500000A000611086F2600000A000F04280F00000A16FE01130C110C3A9400000000281100000A72B700007011086F2700000A066F2800000A281400000A6F1500000A0000066F1E00000A6F2900000A130A2B33110A6F0D00000A7415000001130900281100000A720901007011096F2A00000A11096F2B00000A281400000A6F1500000A0000110A6F2000000A130C110C2DC0DE1D110A751D000001130D110D14FE01130C110C2D08110D6F2100000A00DC0000066F2C00000A2611086F2D00000A0000DE14110814FE01130C110C2D0811086F2100000A00DC002A004164000002000000650000009A010000FF0100001D000000000000000200000042000000EE010000300200001D0000000000000002000000BC02000044000000000300001D000000000000000200000056020000DB0000003103000014000000000000001E02282E00000A2A1B300300CB00000002000011000E047E2F00000A733000000A8102000001000F00283100000A2D120F01283100000A2D090F02283200000A2B01170D092D64000F01280600000A283300000A0A06283400000A0D092D0706283500000A260F01280600000A0F02280F00000A733600000A0B0007028C020000016F3700000A0000DE100714FE010D092D07076F2100000A00DC000516733800000A8104000001002B0C0517733800000A810400000100DE230C000E04086F3900000A733000000A81020000010515733800000A810400000100DE00002A00011C00000200660011770010000000000000120094A60023280000011B300600B90000000300001100000F00283100000A0D093A8E000000000F00280600000A733A00000A0A00178D2A0000011304110416723D0100701F0C283B00000A733C00000AA21104733D00000A0B281100000A076F3E00000A002B1C000716066F3F00000A6F4000000A00281100000A076F4100000A0000066F4200000A16FE0416FE010D092DD4281100000A6F4300000A0000DE100614FE010D092D07066F2100000A00DC000000DE160C00281100000A086F3900000A6F1500000A0000DE00002A000000011C000002001E006E8C00100000000000000100A0A10016280000011E02282E00000A2A42534A4201000100000000000C00000076322E302E35303732370000000005006C00000010040000237E00007C0400002806000023537472696E677300000000A40A00004801000023555300EC0B0000100000002347554944000000FC0B00005C01000023426C6F620000000000000002000001471502000900000000FA013300160000010000002C00000003000000050000000B000000430000000500000003000000010000000300000000000A00010000000000060063005C000A008B0076000A00950076000A009C0076000A00A50076000600660147010600A00180010600C00180010A00F901DE010A0025020F0206003A025C000E00530248020E005F0248020E007B0248020E00830248020600B1029E020E00D70248020E00FD0248020A001503DE010A002003DE010A004B030F020A007B0368030A0099036A000600A3035C000600A8035C000600CC035C000600E5035C000A0007040F0206003A045C000A004E040F020A005C0468030A006E0468030A0078046A000A00D0046803060029051F0506003F051F05060050051F0506006E051F0506007B051F05060090055C000600A6051F050A00B305DE010A00C705DE010600E6051F050000000001000000000001000100010010003300000005000100010001001000440000000500010003005020000000009600B0000A0001000824000000008618D500180006001024000000009600DB001C0006000425000000009600E9002C000B00E825000000008618D50018000C0000000100F600000002000701000003000D01000004001801000005002701000001002D01000002003201000003003701020004003E010200050073010000010032013100D50018003900D50032004100D50018004900D50018005100D5001800110030023C005900410240006100D5001800190069024600610076024B0071008F0251007900BD0256008100CB025B007100EE025F0029003002640089000A036800990028036E00710030023C00710031033C0059003F037300A10046037A00510058037F00B10087037A00C100BA038400D100D1038B00A900D7039200D900EB039800B100F4033200B100FD039F0051001E04A400E1002D04A900810031046400E90046041800F100D5007A00F9006904180001018404B000010194047A005100A404B700F900B3043C000101C0043C001101BD025600B100E6043C00B10030025B000101F804BD00F900080518000900D500180059000E05DC001100D5007A0011001405640029001405640019012E05DF0021014905E40021015E05E9003101D500F000390186059F002100D500320041019A053C004901D5007A005101BF0501015101D50005015901D5000D01A100D50515016101F1053C005901FA051C01A1000406150161011306BD00A100180618002000230037002E00130033012E001B003C01600023003700800023003700C100F6002201048000000000000000000000000000000000B0000000020000000000000000000000010053000000000002000000000000000000000001006A0000000000020000000000000000000000010048020000000000000000003C4D6F64756C653E004C6F67676572426173655F457865635F4E6F6E5F5472616E7361637465645F51756572792E646C6C0053746F72656450726F636564757265730052656164577269746546696C6573006D73636F726C69620053797374656D004F626A6563740053797374656D2E446174610053797374656D2E446174612E53716C54797065730053716C537472696E670053716C586D6C0053716C496E7433320053716C426F6F6C65616E004C6F67676572426173655F457865635F4E6F6E5F5472616E7361637465645F5175657279002E63746F720057726974655465787446696C6500526561645465787446696C6500436F6E6E656374696F6E537472696E6700517565727900506172616D657465727300436F6D6D616E6454696D656F75740044656275670074657874007061746800617070656E640065786974436F64650053797374656D2E52756E74696D652E496E7465726F705365727669636573004F7574417474726962757465006572726F724D6573736167650053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465004D6963726F736F66742E53716C5365727665722E5365727665720053716C50726F6365647572654174747269627574650053797374656D2E446174612E53716C436C69656E740053716C436F6D6D616E64006765745F56616C756500537472696E6700436F6E6361740053797374656D2E586D6C00586D6C446F63756D656E7400586D6C52656164657200437265617465526561646572004C6F616400586D6C4E6F646500586D6C4E6F64654C697374006765745F4368696C644E6F6465730053797374656D2E436F6C6C656374696F6E730049456E756D657261746F7200476574456E756D657261746F72006765745F43757272656E7400586D6C417474726962757465436F6C6C656374696F6E006765745F4174747269627574657300586D6C417474726962757465006765745F4974656D4F660053716C436F6E746578740053716C50697065006765745F50697065006765745F496E6E65725465787400466F726D61740053656E640053716C506172616D6574657200437265617465506172616D657465720053797374656D2E446174612E436F6D6D6F6E004462506172616D65746572007365745F506172616D657465724E616D650053716C44625479706500547970650052756E74696D655479706548616E646C65004765745479706546726F6D48616E646C6500456E756D005061727365007365745F53716C44625479706500496E743332005472795061727365007365745F53697A65007365745F56616C75650053716C506172616D65746572436F6C6C656374696F6E006765745F506172616D657465727300416464004D6F76654E6578740049446973706F7361626C6500446973706F73650053716C436F6E6E656374696F6E004462436F6E6E656374696F6E004F70656E004462436F6D6D616E6400436F6D6D616E6454797065007365745F436F6D6D616E6454797065007365745F436F6D6D616E6454657874007365745F436F6E6E656374696F6E006765745F4461746162617365006765745F436F6D6D616E6454657874004462506172616D65746572436F6C6C656374696F6E006765745F506172616D657465724E616D6500457865637574654E6F6E517565727900436C6F736500456D707479006765745F49734E756C6C0053797374656D2E494F0050617468004765744469726563746F72794E616D65004469726563746F727900457869737473004469726563746F7279496E666F004372656174654469726563746F72790053747265616D57726974657200546578745772697465720057726974654C696E6500457863657074696F6E006765745F4D6573736167650053747265616D5265616465720053716C4D65746144617461006765745F4D61780053716C446174615265636F72640053656E64526573756C74735374617274005465787452656164657200526561644C696E6500536574537472696E670053656E64526573756C7473526F77005065656B0053656E64526573756C7473456E640000001D3B0045006E006C006900730074003D00660061006C00730065003B00001B50006100720061006D0065007400650072004E0061006D0065000063500072006F00630065007300730069006E006700200070006100720061006D006500740065007200200027007B0030007D00270020007700690074006800200061002000760061006C007500650020006F006600200027007B0031007D0027002E00010D4400420054007900700065000009530069007A006500005143006F006E006E0065006300740069006E006700200074006F0020007B0030007D00200061006E0064002000730065006E00640069006E0067002000710075006500720079003A0020007B0031007D00003350006100720061006D0065007400650072003A0020007B0030007D002000560061006C00750065003A0020007B0031007D0000094C0069006E0065000000CF6B1C8C021E5D40BE581D1E41B5B3D70008B77A5C561934E0890D00050111091109120D11111115032000010F000501110911091115101111101109050001011109042001010804010000000320000E0500020E0E0E0420001235052001011235042000123D04200012410320001C04200012450320000205200112490E04000012510600030E0E1C1C042001010E0420001255060001126111650600021C12610E05200101115D060002020E1008042001011C04200012710620011255125506200101118085052001011279032000081A070E12290E0E123112391239125508127912551241124102127502060E0400010E0E040001020E0600011280950E052002010E020A07040E1280991280A1020300000A072003010E115D0A072001011D1280A9062001011280AD05200201080E1007051280A51280AD1280A1021D1280A90801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F777301007033000000000000000000008E3300000020000000000000000000000000000000000000000000008033000000000000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF2500204000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000BC0200000000000000000000BC0234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B0041C020000010053007400720069006E006700460069006C00650049006E0066006F000000F801000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E003000000074002900010049006E007400650072006E0061006C004E0061006D00650000004C006F00670067006500720042006100730065005F0045007800650063005F004E006F006E005F005400720061006E007300610063007400650064005F00510075006500720079002E0064006C006C00000000002800020001004C006500670061006C0043006F0070007900720069006700680074000000200000007C00290001004F0072006900670069006E0061006C00460069006C0065006E0061006D00650000004C006F00670067006500720042006100730065005F0045007800650063005F004E006F006E005F005400720061006E007300610063007400650064005F00510075006500720079002E0064006C006C0000000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E00300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000C000000A0330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
      WITH PERMISSION_SET = EXTERNAL_ACCESS
      GO
      
GO
CREATE TABLE [LoggerBase].[Config_Saved] (
    [ConfigName]     VARCHAR (500) NOT NULL,
    [ConfigXML]      XML           NOT NULL,
    [CreateDateTime] DATETIME2 (7) CONSTRAINT [DF_Config_Saved_CreateDateTime] DEFAULT (getutcdate()) NOT NULL,
    CONSTRAINT [PK_Config_Saved] PRIMARY KEY CLUSTERED ([ConfigName] ASC)
);

GO
CREATE TABLE [LoggerBase].[Config_SessionContext] (
    [SessionContextID]      UNIQUEIDENTIFIER NULL,
    [Config]                XML              NULL,
    [OverrideLogLevelName]  VARCHAR (500)    NULL,
    [ExpirationDatetimeUTC] DATETIME2 (7)    NULL
);

GO
CREATE TABLE [LoggerBase].[Core_Level] (
    [LogLevelName]  VARCHAR (500) NOT NULL,
    [LogLevelValue] INT           NOT NULL,
    [LogLevelDesc]  VARCHAR (MAX) NOT NULL
);


GO
CREATE UNIQUE NONCLUSTERED INDEX [UX_LoggerBase_Core_Level_LogLevelName]
    ON [LoggerBase].[Core_Level]([LogLevelName] ASC);

GO
IF NOT EXISTS (SELECT * FROM LoggerBase.Config_Saved WHERE ConfigName = 'DEFAULT')
INSERT INTO LoggerBase.Config_Saved
(
	 ConfigName
	,ConfigXML
)
VALUES
(
	 'DEFAULT'
	,'<log4mssql>
	<appender name="Saved-Default-Console" type="LoggerBase.Appender_ConsoleAppender">
	<layout type="LoggerBase.Layout_PatternLayout">
	<conversionPattern value="%timestamp %level %logger-%message" />
	</layout>
	</appender>
	<root>
	<level value="INFO" />
	<appender-ref ref="Saved-Default-Console" />
	</root>
	</log4mssql>'
)
GO


GO
IF NOT EXISTS (SELECT * FROM LoggerBase.Core_Level)
INSERT INTO LoggerBase.Core_Level VALUES
 ('OFF',2147483647,'Level designates a higher level than all the rest.'),
 ('EMERGENCY',120000,'Level designates very severe error events;System unusable, emergencies.'),
 ('FATAL',110000,'Level designates very severe error events that will presumably lead the application to abort.'),
 ('ALERT',100000,'Level designates very severe error events. Take immediate action, alerts.'),
 ('CRITCAL',90000,'Level designates very severe error events. Critical condition, critical.'),
 ('SEVERE',80000,'Level designates very severe error events.'),
 ('ERROR',70000,'Level designates error events that might still allow the application to continue running.'),
 ('WARN',60000,'Level designates potentially harmful situations.'),
 ('NOTICE',50000,'Level designates informational messages that highlight the progress of the application at coarse-grained level.'),
 ('INFO',40000,'Level designates informational messages that highlight the progress of the application at coarse-grained level.'),
 ('DEBUG',30000,'Level designates fine-grained informational events that are most useful to debug an application.'),
 ('FINE',30000,'Level designates fine-grained informational events that are most useful to debug an application.'),
 ('TRACE',20000,'Level designates fine-grained informational events that are most useful to debug an application.'),
 ('FINER',20000,'Level designates fine-grained informational events that are most useful to debug an application.'),
 ('VERBOSE',10000,'Level designates fine-grained informational events that are most useful to debug an application.'),
 ('FINEST',10000,'Level designates fine-grained informational events that are most useful to debug an application.'),
 ('ALL',-2147483647,'Level designates the lowest level possible.');
GO


GO

CREATE FUNCTION LoggerBase.Config_Appenders_Get(@Config XML)
RETURNS TABLE
AS

	RETURN

	SELECT 
	ROW_NUMBER() OVER (ORDER BY t.appender.value('./@name', 'VARCHAR(500)')) AS RowID
	,t.appender.value('./@name', 'VARCHAR(500)') AS AppenderName
	,t.appender.value('./@type', 'SYSNAME') as AppenderType
	,t.appender.query('.') AS AppenderConfig
	FROM @Config.nodes('/log4mssql/appender') as t(appender)


GO

CREATE FUNCTION LoggerBase.Core_Level_RetrieveFromSession()
RETURNS VARCHAR(500)
AS
BEGIN
	DECLARE @Level VARCHAR(500) =
	(
		SELECT OverrideLogLevelName
		FROM LoggerBase.Config_SessionContext
		WHERE SessionContextID = LoggerBase.Session_ContextID_Get()
	)

	RETURN @Level
END
GO

CREATE FUNCTION LoggerBase.Layout_GetConversionPatternFromConfig(@Config XML)
RETURNS VARCHAR(MAX)
AS
BEGIN

	DECLARE @ConversionPattern VARCHAR(MAX)
    SELECT @ConversionPattern = t.conversionPattern.value('./@value', 'varchar(max)')
	FROM @Config.nodes('./layout/conversionPattern') as t(conversionPattern)

	RETURN @ConversionPattern

END
GO

CREATE FUNCTION LoggerBase.Layout_GetDate()
RETURNS DATE
AS
BEGIN

    RETURN CAST(GETDATE() AS DATE)

END
GO

CREATE FUNCTION LoggerBase.Layout_LoginUser()
RETURNS NVARCHAR(256)
AS
BEGIN

    RETURN SUSER_NAME()

END
GO

CREATE FUNCTION LoggerBase.Session_ContextID_Get()
RETURNS VARBINARY(128)
AS
BEGIN
	RETURN  CONTEXT_INFO()
END
GO

CREATE FUNCTION LoggerBase.Session_Level_Get()
RETURNS VARCHAR(500)
AS
BEGIN
	DECLARE @Level VARCHAR(500) =
	(
		SELECT OverrideLogLevelName
		FROM LoggerBase.Config_SessionContext
		WHERE SessionContextID = LoggerBase.Session_ContextID_Get()
	)

	RETURN @Level
END
GO

/*********************************************************************************************

    FUNCTION LoggerBase.Config_Layout

    Date:           07/07/2017
    Author:         Jerome Pion
    Description:    A simple implemention of a pattern layout that does simple token replacement.

    --TEST
	SELECT * FROM LoggerBase.Config_Layout('   <appender name="A1" type="LoggerBase.Appender_ConsoleAppender">
 
        <!-- A1 uses PatternLayout -->
        <layout type="LoggerBase.Layout_PatternLayout">
            <conversionPattern value="%-4timestamp [%thread] %-5level %logger %ndc - %message%newline" />
        </layout>
    </appender>')

**********************************************************************************************/

CREATE FUNCTION LoggerBase.Config_Layout(@Config XML)
RETURNS TABLE
AS
	RETURN
	SELECT 
	 t.layout.value('./@type', 'varchar(500)') AS LayoutType
	,t.layout.query('.')                       AS LayoutConfig
	FROM @Config.nodes('./appender/layout') AS t(layout)


GO

CREATE FUNCTION LoggerBase.Config_RetrieveFromSession()
RETURNS XML
AS
BEGIN
	DECLARE @Config XML =
	(
		SELECT Config
		FROM LoggerBase.Config_SessionContext
		WHERE SessionContextID = LoggerBase.Session_ContextID_Get()
	)

	RETURN @Config
END
GO

CREATE FUNCTION LoggerBase.Config_Root_Get(@Config XML)
RETURNS @Root TABLE
(
	 RowID      INT
	,LevelValue VARCHAR(500)
	,AppenderRef VARCHAR(500)
)
AS
BEGIN
	INSERT INTO @Root
	SELECT 
	ROW_NUMBER() OVER (ORDER BY AR.AppenderRef) AS RowID
	,LV.LevelValue
	,AR.AppenderRef
	FROM
	(
		SELECT @Config.value('(/log4mssql/root/level/@value)[1]', 'varchar(500)') AS LevelValue
	) AS LV
	CROSS JOIN
	(
		SELECT 
		t.rootnode.value('@ref', 'varchar(500)') AS AppenderRef
		FROM @Config.nodes('/log4mssql/root/appender-ref') as t(rootnode)
	) AS AR

	RETURN

END

GO
IF ServerProperty('EngineEdition') = 5
BEGIN
	DECLARE @Message NVARCHAR(MAX);SELECT @Message = CONCAT(CONVERT(NVARCHAR,GETDATE(),121),':LoggerBase.Appender_File_WriteTextFile requires CLR with external access which is not supported in Azure. This appendeder will not be available.'); RAISERROR(@Message,0,1);
END
ELSE
BEGIN
EXEC('
CREATE PROCEDURE LoggerBase.Appender_File_WriteTextFile
(
	 @text   NVARCHAR(4000)
	,@path   NVARCHAR(4000) 
	,@append BIT
	,@exitCode INT OUTPUT
	,@errorMessage NVARCHAR(4000) OUTPUT
)
WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME log4mssql.ReadWriteFiles.WriteTextFile
')
END
GO

/*********************************************************************************************

    PROCEDURE LoggerBase.Session_ContextID_Set

    Date:           07/24/2017
    Author:         Jerome Pion
    Description:    

    --TEST

**********************************************************************************************/

CREATE PROCEDURE LoggerBase.Session_ContextID_Set
(
     @ContextID UNIQUEIDENTIFIER
	,@Debug  BIT = 0
)

AS

    SET NOCOUNT ON

	SET CONTEXT_INFO @ContextID

GO

/*********************************************************************************************

    PROCEDURE LoggerBase.Session_Level_Set

    Date:           07/17/2017
    Author:         Jerome Pion
    Description:    

    --TEST

**********************************************************************************************/

CREATE PROCEDURE LoggerBase.Session_Level_Set
(
     @LogLevelName VARCHAR(500)
	,@Debug  BIT = 0
)

AS

    SET NOCOUNT ON

	IF EXISTS (SELECT * FROM LoggerBase.Config_SessionContext
		WHERE SessionContextID = LoggerBase.Session_ContextID_Get()
	)
	BEGIN
		IF (@Debug = 1)
		BEGIN
			PRINT CONCAT('[',OBJECT_NAME(@@PROCID), ']:Updating existing session:')
		END
		UPDATE LoggerBase.Config_SessionContext
		SET OverrideLogLevelName = @LogLevelName
		WHERE SessionContextID = LoggerBase.Session_ContextID_Get()
	END
	ELSE
	BEGIN

		DECLARE @SessionID UNIQUEIDENTIFIER = NEWID()
				
		IF (@Debug = 1)
		BEGIN
			PRINT CONCAT('[',OBJECT_NAME(@@PROCID), ']:Creating new session:', @SessionID)
		END

		INSERT INTO LoggerBase.Config_SessionContext
		(SessionContextID, Config, OverrideLogLevelName, ExpirationDatetimeUTC)
		VALUES (@SessionID, NULL, @LogLevelName, DATEADD(DAY, 1, GETUTCDATE()))

		EXEC LoggerBase.Session_ContextID_Set @SessionID

	END

GO

/*********************************************************************************************

    PROCEDURE LoggerBase.Session_Clear

    Date:           07/17/2017
    Author:         Jerome Pion
    Description:    

    --TEST

**********************************************************************************************/

CREATE PROCEDURE LoggerBase.Session_Clear
(
     @Debug  BIT = 0
)

AS

    SET NOCOUNT ON

	DELETE LoggerBase.Config_SessionContext
	WHERE SessionContextID = LoggerBase.Session_ContextID_Get()
	
GO

/*********************************************************************************************

    PROCEDURE LoggerBase.Session_Config_Set

    Date:           07/12/2017
    Author:         Jerome Pion
    Description:    Returns the lowest-level config given the current state. 
					The order of preference is:
					*Passed in config XML
					*Saved config name
					*Session config
					*Saved default config
					*Hard-coded config

    --TEST

**********************************************************************************************/

CREATE PROCEDURE LoggerBase.Session_Config_Set
(
	 @Override XML = NULL
    ,@Config XML OUTPUT
	,@Debug  BIT = 0
)

AS

    SET NOCOUNT ON

	IF EXISTS (SELECT * FROM LoggerBase.Config_SessionContext
		WHERE SessionContextID = LoggerBase.Session_ContextID_Get()
	)
	BEGIN
		UPDATE LoggerBase.Config_SessionContext
		SET Config = @Config
		WHERE SessionContextID = LoggerBase.Session_ContextID_Get()
	END
	ELSE
	BEGIN
		DECLARE @SessionID UNIQUEIDENTIFIER = NEWID()
		INSERT INTO LoggerBase.Config_SessionContext
		(SessionContextID, Config, OverrideLogLevelName, ExpirationDatetimeUTC)
		VALUES (@SessionID, @Config, NULL, DATEADD(DAY, 1, GETUTCDATE()))
		
		EXEC LoggerBase.Session_Config_Set @SessionID

	END

GO

/*********************************************************************************************

    PROCEDURE LoggerBase.Layout_PatternLayout

    Date:           07/18/2017
    Author:         Jerome Pion
    Description:    A simple implemention of a pattern layout that does simple token replacement.

    --TEST
	DECLARE @FormattedMessage VARCHAR(MAX)
	EXEC LoggerBase.Layout_PatternLayout 
	  @LoggerName   = 'LoggerName'
	, @LogLevelName = 'DEBUG'
	, @Message      = 'A test message'
	, @Config       = '<layout type="LoggerBase.Layout_PatternLayout"><conversionPattern value="[%timestamp] [%thread] %level - %logger - %message%newline"/></layout>'
	, @Debug        = 0
	, @FormattedMessage = @FormattedMessage OUTPUT
	SELECT @FormattedMessage

**********************************************************************************************/

CREATE PROCEDURE LoggerBase.Layout_PatternLayout
(
	  @LoggerName   VARCHAR(500)
	, @LogLevelName VARCHAR(500)
	, @Message      VARCHAR(MAX)
	, @Config       XML
	, @Debug        BIT=0
	, @FormattedMessage VARCHAR(MAX) OUTPUT
)
AS
	SET NOCOUNT ON
	
	DECLARE @ConversionPattern VARCHAR(MAX) = LoggerBase.Layout_GetConversionPatternFromConfig(@Config)

	SET @FormattedMessage = @ConversionPattern
	
	SET @FormattedMessage = REPLACE(@FormattedMessage COLLATE Latin1_General_CS_AS, '%c ', @LoggerName)
	SET @FormattedMessage = REPLACE(@FormattedMessage, '%d ', LoggerBase.Layout_GetDate())
	SET @FormattedMessage = REPLACE(@FormattedMessage, '%date', LoggerBase.Layout_GetDate())
	SET @FormattedMessage = REPLACE(@FormattedMessage, '%identity', LoggerBase.Layout_LoginUser())
	SET @FormattedMessage = REPLACE(@FormattedMessage, '%level', @LogLevelName)
	SET @FormattedMessage = REPLACE(@FormattedMessage, '%logger', @LoggerName)
	SET @FormattedMessage = REPLACE(@FormattedMessage, '%m ', @Message)
	SET @FormattedMessage = REPLACE(@FormattedMessage, '%message', @Message)
	SET @FormattedMessage = REPLACE(@FormattedMessage, '%n ', CHAR(13))
	SET @FormattedMessage = REPLACE(@FormattedMessage, '%newline', CHAR(13))
	SET @FormattedMessage = REPLACE(@FormattedMessage, '%p ', @LogLevelName)
	SET @FormattedMessage = REPLACE(@FormattedMessage, '%r ', SYSDATETIME())
	SET @FormattedMessage = REPLACE(@FormattedMessage, '% ', @@SPID)
	SET @FormattedMessage = REPLACE(@FormattedMessage, '%thread', @@SPID)
	SET @FormattedMessage = REPLACE(@FormattedMessage, '%timestamp', SYSDATETIME())
	SET @FormattedMessage = REPLACE(@FormattedMessage, '%u ', LoggerBase.Layout_LoginUser())
	SET @FormattedMessage = REPLACE(@FormattedMessage, '%username', LoggerBase.Layout_LoginUser())
	SET @FormattedMessage = REPLACE(@FormattedMessage, '%utcdate', SYSUTCDATETIME())
	SET @FormattedMessage = REPLACE(@FormattedMessage, '%w ', LoggerBase.Layout_LoginUser())

GO

/*********************************************************************************************

    PROCEDURE LoggerBase.Config_Appenders_FilteredByLevel

    Date:           07/12/2017
    Author:         Jerome Pion
    Description:    Returns the appender configurations that still fire for the requested level.

    --TEST
	DECLARE @InfoConfig XML = '<log4mssql><appender name="Saved-Default-Console" type="LoggerBase.Appender_ConsoleAppender"><layout type="LoggerBase.Layout_PatternLayout"><conversionPattern value="%timestamp %level %logger-%message"/></layout></appender><root><level value="INFO"/><appender-ref ref="Saved-Default-Console"/></root></log4mssql>'
	DECLARE @RequestedLogLevelName VARCHAR(500) = 'DEBUG'

	EXEC LoggerBase.Config_Appenders_FilteredByLevel @Config = @InfoConfig, @RequestedLogLevelName = @RequestedLogLevelName, @Debug = 1

	DECLARE @DebugConfig XML = '<log4mssql><appender name="Saved-Default-Console" type="LoggerBase.Appender_ConsoleAppender"><layout type="LoggerBase.Layout_PatternLayout"><conversionPattern value="%timestamp %level %logger-%message"/></layout></appender><root><level value="DEBUG"/><appender-ref ref="Saved-Default-Console"/></root></log4mssql>'

	EXEC LoggerBase.Config_Appenders_FilteredByLevel @Config = @DebugConfig, @RequestedLogLevelName = @RequestedLogLevelName, @Debug = 1

**********************************************************************************************/

CREATE PROCEDURE LoggerBase.Config_Appenders_FilteredByLevel
(
	 @Config                XML
	,@RequestedLogLevelName VARCHAR(500)
	,@Debug                 BIT = 0               
)

AS

    SET NOCOUNT ON

	IF (@Debug = 1)
	BEGIN
		PRINT CONCAT('[',OBJECT_NAME(@@PROCID), ']:@Config:', CONVERT(VARCHAR(5000), @Config))
		PRINT CONCAT('[',OBJECT_NAME(@@PROCID), ']:@RequestedLogLevelName:', @RequestedLogLevelName)
		DECLARE @RowCount INT = (SELECT COUNT(*) FROM LoggerBase.Config_Root_Get(@Config))
		PRINT CONCAT('[',OBJECT_NAME(@@PROCID), ']:LoggerBase.Config_Root returned rowcount:', @RowCount)
		SET @RowCount = (SELECT COUNT(*) FROM LoggerBase.Config_Appenders_Get(@Config))
		PRINT CONCAT('[',OBJECT_NAME(@@PROCID), ']:LoggerBase.Config_Appenders_Get returned rowcount:', @RowCount)
		PRINT CONCAT('[',OBJECT_NAME(@@PROCID), ']:OverrideLogLevel:', LoggerBase.Session_Level_Get()) 
	END

	SELECT 
	ROW_NUMBER() OVER (ORDER BY A.AppenderName) AS RowID
	,A.AppenderType
	,A.AppenderConfig
	FROM       LoggerBase.Config_Root_Get     (@Config) R
	INNER JOIN LoggerBase.Config_Appenders_Get(@Config) A ON R.AppenderRef = A.AppenderName
	--Check if we have an override in the session that changes the root-appender defined logging level.
	INNER JOIN LoggerBase.Core_Level                    LL ON COALESCE(LoggerBase.Session_Level_Get(),  R.LevelValue)  = LL.LogLevelName
	AND LL.LogLevelValue <= (SELECT LogLevelValue FROM LoggerBase.Core_Level WHERE LogLevelName = @RequestedLogLevelName)
	
GO

/*********************************************************************************************

    PROCEDURE LoggerBase.Config_Retrieve

    Date:           07/12/2017
    Author:         Jerome Pion
    Description:    Returns the lowest-level config given the current state. 
					The order of preference is:
					*Passed in config XML
					*Saved config name
					*Session config
					*Saved default config
					*Hard-coded config

    --TEST

**********************************************************************************************/

CREATE PROCEDURE LoggerBase.Config_Retrieve
(
	 @Override XML = NULL
    ,@Config XML OUTPUT
	,@Debug  BIT = 0
)

AS

    SET NOCOUNT ON

	IF (@Override IS NOT NULL) 
	BEGIN
		SET @Config = @Override
		RETURN
	END

	IF (@Override IS NULL)
	SELECT @Config = LoggerBase.Config_RetrieveFromSession()

	IF (@Config IS NULL)
	SELECT @Config = ConfigXML FROM LoggerBase.Config_Saved WHERE ConfigName = 'DEFAULT'

	IF (@Config IS NULL)
	SELECT @Config = '<log4mssql>
    <appender name="Hard-Coded-Console" type="Logger.Appender_ConsoleAppender">
        <layout type="Logger.Layout_PatternLayout">
            <conversionPattern value="%timestamp %level %logger-%message" />
        </layout>
    </appender>
	   <root>
        <level value="DEBUG" />
        <appender-ref ref="Hard-Coded-Console" />
    </root>
</log4mssql>'

GO

/*********************************************************************************************

    PROCEDURE LoggerBase.Layout_FormatMessage

    Date:           07/14/2017
    Author:         Jerome Pion
    Description:    Execute the request layout and return the formatted message.

    --TEST
	DECLARE 
	  @LayoutTypeName   SYSNAME
    , @LoggerName       VARCHAR(500)
	, @LogLevelName     VARCHAR(500)
	, @Message          VARCHAR(MAX)
	, @LayoutConfig     XML
	, @Debug            BIT
    , @FormattedMessage VARCHAR(MAX)

	EXEC LoggerBase.Layout_FormatMessage 
		  @LayoutTypeName  = 'LoggerBase.Layout_PatternLayout'
		, @LoggerName      = 'LoggerName'
		, @LogLevelName    = 'DEBUG'
		, @Message         = 'A test message'
		, @LayoutConfig    = '<layout type="Logger.Layout_PatternLayout"><conversionPattern value="[%timestamp] [%thread] %level - %logger - %message%newline"/></layout>'
		, @Debug           = 1
		, @FormattedMessage = @FormattedMessage OUTPUT

	SELECT @FormattedMessage

**********************************************************************************************/

CREATE PROCEDURE LoggerBase.Layout_FormatMessage
(
	  @LayoutTypeName   SYSNAME
    , @LoggerName       VARCHAR(500)
	, @LogLevelName     VARCHAR(500)
	, @Message          VARCHAR(MAX)
	, @LayoutConfig     XML
	, @Debug            BIT
	, @FormattedMessage VARCHAR(MAX) OUTPUT
)

AS

    SET NOCOUNT ON
	
	DECLARE @SQL NVARCHAR(MAX) = CONCAT(@LayoutTypeName, ' @LoggerName, @LogLevelName, @Message, @Config, @Debug, @FormattedMessage OUTPUT')

	IF (@Debug = 1) 
	BEGIN
		PRINT CONCAT('[',OBJECT_NAME(@@PROCID),']:@SQL:', @SQL)
		PRINT CONCAT('[',OBJECT_NAME(@@PROCID),']:@LoggerName:', @LoggerName)
	END

	EXECUTE sp_executesql @SQL, N'@LoggerName VARCHAR(500), @LogLevelName VARCHAR(500), @Message VARCHAR(MAX), @Config XML, @Debug BIT, @FormattedMessage VARCHAR(MAX) OUTPUT'
	,@LoggerName       = @LoggerName
	,@LogLevelName     = @LogLevelName
	,@Message          = @Message
	,@Config           = @LayoutConfig
	,@Debug            = @Debug
	,@FormattedMessage = @FormattedMessage OUTPUT

GO
IF ServerProperty('EngineEdition') = 5
BEGIN
	DECLARE @Message NVARCHAR(MAX);SELECT @Message = CONCAT(CONVERT(NVARCHAR,GETDATE(),121),':LoggerBase.Appender_MSSQLSQLDatabaseAppender_ExecNonTransactedQuery requires CLR with external access which is not supported in Azure. This appendeder will not be available.'); RAISERROR(@Message,0,1);
END
ELSE
BEGIN
EXEC('
CREATE PROCEDURE [LoggerBase].[Appender_MSSQLSQLDatabaseAppender_ExecNonTransactedQuery]
(
	@ConnectionString NVARCHAR(4000),
	@Query NVARCHAR(4000),
	@Parameters XML,
	@CommandTimeout INT = 5,
	@Debug BIT = 0
)
WITH EXECUTE AS CALLER
AS
EXTERNAL NAME [log4mssql].[StoredProcedures].[LoggerBase_Exec_Non_Transacted_Query]
')
END
GO

/*********************************************************************************************

    PROCEDURE LoggerBase.Appender_ConsoleAppender

    Date:           07/14/2017
    Author:         Jerome Pion
    Description:    Invokes the requested appender using the provided XML configuration.

    --TEST
	DECLARE @LoggerName   VARCHAR(500) = 'TestAppenderLoggerBase'
	DECLARE @LogLevelName VARCHAR(500) = 'DEBUG'
	DECLARE @Message      VARCHAR(MAX) = 'Appender test message!'
	DECLARE @Config       XML          = '<appender name="A1" type="LoggerBase.Appender_ConsoleAppender">
	<!-- A1 uses PatternLayout -->
	<layout type="LoggerBase.Layout_PatternLayout">
	<conversionPattern value="%timestamp [%thread] %level %LoggerBase - %message%newline"/>
	</layout>
	</appender>'

	EXEC LoggerBase.Appender_ConsoleAppender 
	  @LoggerName   = @LoggerName
	, @LogLevelName = @LogLevelName 
	, @Message      = @Message
	, @Config       = @Config
	, @Debug        = 1

**********************************************************************************************/

CREATE PROCEDURE LoggerBase.Appender_ConsoleAppender (@LoggerName VARCHAR(500), @LogLevelName VARCHAR(500), @Message VARCHAR(MAX), @Config XML, @Debug BIT=0)
AS
	
	SET NOCOUNT ON

	IF (@Debug = 1) PRINT CONCAT('[',OBJECT_NAME(@@PROCID),']:@Message:', @Message)

	DECLARE @FormattedMessage VARCHAR(MAX)
	DECLARE @LayoutType       SYSNAME
	DECLARE @LayoutConfig     XML
	DECLARE @SQL              NVARCHAR(MAX)

	SELECT @LayoutType = LayoutType, @LayoutConfig = LayoutConfig FROM LoggerBase.Config_Layout(@Config)

	IF (@Debug = 1)
	BEGIN
		PRINT CONCAT('[',OBJECT_NAME(@@PROCID),']:@Config:'    , CONVERT(VARCHAR(MAX), @Config))
		PRINT CONCAT('[',OBJECT_NAME(@@PROCID),']:@LoggerName:', @LoggerName)
		PRINT CONCAT('[',OBJECT_NAME(@@PROCID),']:@LayoutType:', @LayoutType)
		PRINT CONCAT('[',OBJECT_NAME(@@PROCID),']:@SQL:'       , @SQL)
	END

	EXEC LoggerBase.Layout_FormatMessage 
		  @LayoutTypeName  = @LayoutType
		, @LoggerName      = @LoggerName
		, @LogLevelName    = @LogLevelName
		, @Message         = @Message
		, @LayoutConfig    = @LayoutConfig
		, @Debug           = @Debug
		, @FormattedMessage = @FormattedMessage OUTPUT

	PRINT @FormattedMessage

GO
GO
IF ServerProperty('EngineEdition') = 5
BEGIN
	DECLARE @Message NVARCHAR(MAX);SELECT @Message = CONCAT(CONVERT(NVARCHAR,GETDATE(),121),':LoggerBase.Appender_MSSQLDatabaseAppender requires CLR with external access which is not supported in Azure. This appendeder will not be available.'); RAISERROR(@Message,0,1);
END
ELSE
BEGIN
EXEC('
/*********************************************************************************************

    PROCEDURE LoggerBase.Appender_MSSQLDatabaseAppender
   
    Property of Clearent, LLC
    Date:           07/07/2017
    Author:         Jerome Pion
    Description:    Writes logging entries to database without enlisting in a transaction.

	/*jpion: 2017-07-29: Changed name to reflect that tacking "Enlist=false" to the connection string may only work for MSSQL Server*/
    --TEST

	DECLARE @Config XML = 
''<appender name="MSSQLAppender" type="LoggerBase.Appender_MSSQLDatabaseAppender">
	<connectionString value="data source=localhost;initial catalog=LoggerTest;integrated security=true;" />
    <commandText value="INSERT INTO LoggerBase.TestLog ([Date],[Thread],[Level],[Logger],[Message],[Exception]) VALUES (@log_date, @thread, @log_level, @logger, @message, @exception)" />
    <parameter>
        <parameterName value="@log_date" />
        <dbType value="DateTime" />
        <layout type="LoggerBase.Layout_PatternLayout">
            <conversionPattern value="%date" />
        </layout>
    </parameter>
    <parameter>
        <parameterName value="@thread" />
        <dbType value="VarChar" />
	   <size value="255" />
        <layout type="LoggerBase.Layout_PatternLayout">
            <conversionPattern value="%thread" />
        </layout>
    </parameter>
    <parameter>
        <parameterName value="@log_level" />
        <dbType value="VarChar" />
	   <size value="50" />
        <layout type="LoggerBase.Layout_PatternLayout">
            <conversionPattern value="%level" />
        </layout>
    </parameter>
    <parameter>
        <parameterName value="@logger" />
        <dbType value="VarChar" />
	   <size value="255" />
        <layout type="LoggerBase.Layout_PatternLayout">
            <conversionPattern value="%logger" />
        </layout>
    </parameter>
    <parameter>
        <parameterName value="@message" />
        <dbType value="VarChar" />
	   <size value="4000" />
        <layout type="LoggerBase.Layout_PatternLayout">
            <conversionPattern value="%message" />
        </layout>
    </parameter>
    <parameter>
        <parameterName value="@exception" />
        <dbType value="VarChar" />
	   <size value="2000" />
        <layout type="LoggerBase.Layout_PatternLayout" />
    </parameter>
</appender>''

IF OBJECT_ID(''LoggerBase.TestLog'') IS NOT NULL DROP TABLE LoggerBase.TestLog
CREATE TABLE LoggerBase.TestLog
(
	[Date] DATE
	,[Thread] INT
	,[Level] VARCHAR(500)
	,[Logger] VARCHAR(500)
	,[Message] VARCHAR(MAX)
	,[Exception] VARCHAR(MAX)
)

EXEC LoggerBase.Appender_MSSQLDatabaseAppender @LoggerName = ''TestLogger'', @LogLevelName = ''DEBUG'', @Message = ''This is a test.'', @Config = @Config
, @Debug = 1
SELECT * FROM LoggerBase.TestLog

**********************************************************************************************/

CREATE PROCEDURE LoggerBase.Appender_MSSQLDatabaseAppender
(@LoggerName VARCHAR(500), @LogLevelName VARCHAR(500), @Message VARCHAR(MAX), @Config XML, @Debug BIT=0)
AS
	SET NOCOUNT ON

	IF (@Debug = 1) PRINT CONCAT(OBJECT_NAME(@@PROCID),'':@Message:'', @Message)
	IF (@Debug = 1) PRINT CONCAT(OBJECT_NAME(@@PROCID),'':@Config:'', CONVERT(VARCHAR(MAX),@Config))

	--Get command text
	DECLARE @CommandText VARCHAR(MAX)
	DECLARE @ConnectionString VARCHAR(MAX)

	SELECT @CommandText = t.commandText.value(''./@value'', ''varchar(MAX)'') 
	FROM @Config.nodes(''/appender/commandText'') as t(commandText)

	SELECT @ConnectionString = t.connectionString.value(''./@value'', ''varchar(MAX)'') 
	FROM @Config.nodes(''/appender/connectionString'') as t(connectionString)
	--Loop through parameters. 

	SET @ConnectionString = CONCAT(@ConnectionString, '';Enlist=false;'')

	SELECT 
	ROW_NUMBER() OVER (ORDER BY t.parameter.value(''(parameterName/@value)[1]'', ''varchar(MAX)'')) AS RowID
	,t.parameter.value(''(parameterName/@value)[1]'', ''varchar(MAX)'') AS ParameterName
	,t.parameter.value(''(dbType/@value)[1]'', ''varchar(MAX)'') AS dbType
	,t.parameter.value(''(size/@value)[1]'', ''varchar(MAX)'') AS size
	,t.parameter.value(''(layout/@type)[1]'', ''varchar(MAX)'') AS LayoutType
	,t.parameter.value(''(layout/conversionPattern/@value)[1]'', ''varchar(MAX)'') AS ConversionPattern
	,t.parameter.query(''./layout'') AS ParameterXML
	,CAST('''' AS VARCHAR(MAX)) AS ParameterValue
	INTO #Parameters
	FROM @Config.nodes(''/appender/parameter'') as t(parameter)
		--Get parameter name and datatype
			--Use layout to get value.
			select * from #Parameters
	IF (@Debug = 1) PRINT CONCAT(OBJECT_NAME(@@PROCID), '':@CommandText:'', @CommandText)

	DECLARE @Counter INT
	DECLARE @Limit INT
	DECLARE @SQL NVARCHAR(MAX)

	DECLARE @LayoutTypeName SYSNAME
	DECLARE @LayoutConfig XML
	DECLARE @FormattedMessage VARCHAR(MAX)

	SELECT @Counter = MIN(RowID), @Limit = MAX(RowID)
	FROM #Parameters

	WHILE (@Counter <= @Limit)
	BEGIN
		SELECT @LayoutTypeName = LayoutType
		,@LayoutConfig = ParameterXML
		FROM #Parameters
		WHERE 1=1
		AND RowID = @Counter

	 	EXEC LoggerBase.Layout_FormatMessage 
		  @LayoutTypeName  = @LayoutTypeName
		, @LoggerName      = @LoggerName
		, @LogLevelName    = @LogLevelName
		, @Message         = @Message
		, @LayoutConfig    = @LayoutConfig
		, @Debug           = @Debug
		, @FormattedMessage = @FormattedMessage OUTPUT

	  UPDATE #Parameters SET ParameterValue = @FormattedMessage
	  WHERE 1=1
	  AND RowID = @Counter

		SET @Counter += 1

		IF (@Debug = 1)
		BEGIN
			PRINT CONCAT(''['',OBJECT_NAME(@@PROCID), '']:@LayoutTypeName:'', @LayoutTypeName)
			PRINT CONCAT(''['',OBJECT_NAME(@@PROCID), '']:@LoggerName:'', @LoggerName)
			PRINT CONCAT(''['',OBJECT_NAME(@@PROCID), '']:@LogLevelName:'', @LogLevelName)
			PRINT CONCAT(''['',OBJECT_NAME(@@PROCID), '']:@Message:'', @Message)
			PRINT CONCAT(''['',OBJECT_NAME(@@PROCID), '']:@LayoutConfig:'', CONVERT(VARCHAR(MAX), @LayoutConfig))
		END
	END

	--SELECT * FROM #Parameters

	--Take the parameters and construct the parameters definition and parameters/value list
	DECLARE @ParameterDefinition NVARCHAR(MAX)
	SELECT @ParameterDefinition = COALESCE(@ParameterDefinition+'','' ,'''') + CONCAT(ParameterName, '' '' , dbType, '' = '''''', ParameterValue, '''''''')
	FROM #Parameters

--SELECT @SQL = CONCAT(''DECLARE '', @ParameterDefinition, ''; '', @CommandText)
IF (@Debug = 1) PRINT CONCAT(OBJECT_NAME(@@PROCID), '':@SQL:'', @CommandText)
--BEGIN
----EXEC (@SQL)
--	--EXEC LoggerBase.Appender_MSSQLDatabaseAppender_ExecNonTransactedQuery
--	-- @connectionstring = @ConnectionString
--	--,@query = @SQL
--END
--SELECT 1 AS Tag
--,NULL AS Parent
--,NULL AS [Parameters!1!ParameterName]
--,NULL AS [Parameter!2!DBType]
--,NULL AS [Parameter!2!!CData]
--UNION ALL
--select 2 AS Tag
--,1 AS Parent
--,ParameterName  
--,DBType         
--,ParameterValue
-- FROM #Parameters 
-- FOR XML EXPLICIT;

DECLARE @ParametersXML xml

SET @ParametersXML = (
	SELECT *
	FROM
	(
	SELECT 1        AS Tag
	,NULL           AS Parent
	,NULL           AS [Parameters!1!ParameterName]
	,NULL		 AS [Parameter!2!ParameterName]
	,NULL           AS [Parameter!2!DBType]
	,NULL           AS [Parameter!2!Size]
	,NULL           AS [Parameter!2!!CData]
	UNION ALL
    SELECT 
     2              AS Tag
    ,1              AS Parent
    ,ParameterName  AS [Parameter!2!ParameterName]
    ,ParameterName  AS [Parameter!2!ParameterName]
    ,DBType         AS [Parameter!2!DBType]
    ,Size           AS [Parameter!2!Size]
    ,ParameterValue AS [Parameter!2!!CData]
    FROM #Parameters
	) AS N
    FOR XML EXPLICIT
	--FOR XML PATH(''Parameter''), ROOT(''Parameters'')
 )

 --print CONCAT(''@ParametersXML '', CONVERT(VARCHAR(8000), @ParametersXML))
 IF (@Debug = 1) PRINT CONCAT(''@ParametersXML '', CONVERT(VARCHAR(8000), @ParametersXML))
 ----EXEC (@SQL)
EXEC [LoggerBase].[Appender_MSSQLSQLDatabaseAppender_ExecNonTransactedQuery]
	 @ConnectionString = @ConnectionString
	,@Query            = @CommandText
	,@Parameters       = @ParametersXML
	,@CommandTimeout   = 5
	,@Debug            = @Debug 

')
END
GO
IF OBJECT_ID('LoggerBase.Appender_LocalDatabaseAppender') IS NOT NULL DROP PROCEDURE LoggerBase.Appender_LocalDatabaseAppender
GO

/*********************************************************************************************

    PROCEDURE LoggerBase.Appender_LocalDatabaseAppender
   
    Property of Clearent, LLC
    Date:           11/30/2017
    Author:         Jerome Pion
    Description:    Writes logging entries to the local database within the in-scope transaction.

    --TEST

	DECLARE @Config XML = 
'<appender name="MSSQLAppender" type="LoggerBase.Appender_LocalDatabaseAppender">
    <commandText value="INSERT INTO LoggerBase.TestLog ([Date],[Thread],[Level],[Logger],[Message],[Exception]) VALUES (@log_date, @thread, @log_level, @logger, @message, @exception)" />
    <parameter>
        <parameterName value="@log_date" />
        <dbType value="DateTime" />
        <layout type="LoggerBase.Layout_PatternLayout">
            <conversionPattern value="%date" />
        </layout>
    </parameter>
    <parameter>
        <parameterName value="@thread" />
        <dbType value="VarChar" />
	   <size value="255" />
        <layout type="LoggerBase.Layout_PatternLayout">
            <conversionPattern value="%thread" />
        </layout>
    </parameter>
    <parameter>
        <parameterName value="@log_level" />
        <dbType value="VarChar" />
	   <size value="50" />
        <layout type="LoggerBase.Layout_PatternLayout">
            <conversionPattern value="%level" />
        </layout>
    </parameter>
    <parameter>
        <parameterName value="@logger" />
        <dbType value="VarChar" />
	   <size value="255" />
        <layout type="LoggerBase.Layout_PatternLayout">
            <conversionPattern value="%logger" />
        </layout>
    </parameter>
    <parameter>
        <parameterName value="@message" />
        <dbType value="VarChar" />
	   <size value="4000" />
        <layout type="LoggerBase.Layout_PatternLayout">
            <conversionPattern value="%message" />
        </layout>
    </parameter>
    <parameter>
        <parameterName value="@exception" />
        <dbType value="VarChar" />
	   <size value="2000" />
        <layout type="LoggerBase.Layout_PatternLayout" />
    </parameter>
</appender>'

IF OBJECT_ID('LoggerBase.TestLog') IS NOT NULL DROP TABLE LoggerBase.TestLog
CREATE TABLE LoggerBase.TestLog
(
	[Date] DATE
	,[Thread] INT
	,[Level] VARCHAR(500)
	,[Logger] VARCHAR(500)
	,[Message] VARCHAR(MAX)
	,[Exception] VARCHAR(MAX)
)

EXEC LoggerBase.Appender_LocalDatabaseAppender @LoggerName = 'TestLogger', @LogLevelName = 'DEBUG', @Message = 'This is a test.', @Config = @Config
, @Debug = 1
SELECT * FROM LoggerBase.TestLog

**********************************************************************************************/

CREATE PROCEDURE LoggerBase.Appender_LocalDatabaseAppender
(@LoggerName VARCHAR(500), @LogLevelName VARCHAR(500), @Message VARCHAR(MAX), @Config XML, @Debug BIT=0)
AS
	SET NOCOUNT ON

	IF (@Debug = 1) PRINT CONCAT(OBJECT_NAME(@@PROCID),':@Message:', @Message)
	IF (@Debug = 1) PRINT CONCAT(OBJECT_NAME(@@PROCID),':@Config:', CONVERT(VARCHAR(MAX),@Config))

	--Get command text
	DECLARE @CommandText VARCHAR(MAX)

	SELECT @CommandText = t.commandText.value('./@value', 'varchar(MAX)') 
	FROM @Config.nodes('/appender/commandText') as t(commandText)

	--Loop through parameters. 

	SELECT 
	ROW_NUMBER() OVER (ORDER BY t.parameter.value('(parameterName/@value)[1]', 'varchar(MAX)')) AS RowID
	,t.parameter.value('(parameterName/@value)[1]', 'varchar(MAX)') AS ParameterName
	,t.parameter.value('(dbType/@value)[1]', 'varchar(MAX)') AS dbType
	,t.parameter.value('(size/@value)[1]', 'varchar(MAX)') AS size
	,t.parameter.value('(layout/@type)[1]', 'varchar(MAX)') AS LayoutType
	,t.parameter.value('(layout/conversionPattern/@value)[1]', 'varchar(MAX)') AS ConversionPattern
	,t.parameter.query('./layout') AS ParameterXML
	,CAST('' AS VARCHAR(MAX)) AS ParameterValue
	INTO #Parameters
	FROM @Config.nodes('/appender/parameter') as t(parameter)
		--Get parameter name and datatype
			--Use layout to get value.
	IF (@Debug = 1) PRINT CONCAT(OBJECT_NAME(@@PROCID), ':@CommandText:', @CommandText)

	DECLARE @Counter INT
	DECLARE @Limit INT
	DECLARE @SQL NVARCHAR(MAX)

	DECLARE @LayoutTypeName SYSNAME
	DECLARE @LayoutConfig XML
	DECLARE @FormattedMessage VARCHAR(MAX)

	SELECT @Counter = MIN(RowID), @Limit = MAX(RowID)
	FROM #Parameters

	WHILE (@Counter <= @Limit)
	BEGIN
		SELECT @LayoutTypeName = LayoutType
		,@LayoutConfig = ParameterXML
		FROM #Parameters
		WHERE 1=1
		AND RowID = @Counter

	 	EXEC LoggerBase.Layout_FormatMessage 
		  @LayoutTypeName  = @LayoutTypeName
		, @LoggerName      = @LoggerName
		, @LogLevelName    = @LogLevelName
		, @Message         = @Message
		, @LayoutConfig    = @LayoutConfig
		, @Debug           = @Debug
		, @FormattedMessage = @FormattedMessage OUTPUT

	  UPDATE #Parameters SET ParameterValue = @FormattedMessage
	  WHERE 1=1
	  AND RowID = @Counter

		SET @Counter += 1

		IF (@Debug = 1)
		BEGIN
			PRINT CONCAT('[',OBJECT_NAME(@@PROCID), ']:@LayoutTypeName:', @LayoutTypeName)
			PRINT CONCAT('[',OBJECT_NAME(@@PROCID), ']:@LoggerName:', @LoggerName)
			PRINT CONCAT('[',OBJECT_NAME(@@PROCID), ']:@LogLevelName:', @LogLevelName)
			PRINT CONCAT('[',OBJECT_NAME(@@PROCID), ']:@Message:', @Message)
			PRINT CONCAT('[',OBJECT_NAME(@@PROCID), ']:@LayoutConfig:', CONVERT(VARCHAR(MAX), @LayoutConfig))
		END
	END

	--SELECT * FROM #Parameters

	--Take the parameters and construct the parameters definition and parameters/value list
	DECLARE @ParameterDefinition NVARCHAR(MAX)
	SELECT @ParameterDefinition = COALESCE(@ParameterDefinition+',' ,'') + CONCAT(ParameterName, ' ' , dbType, IIF(size IS NOT NULL, CONCAT('(', size, ')'), ''), ' = ''', ParameterValue, '''')
	FROM #Parameters

IF (@Debug = 1) PRINT CONCAT(OBJECT_NAME(@@PROCID), ':@SQL:', @CommandText)

SELECT @SQL = CONCAT('DECLARE ', @ParameterDefinition, '; ', @CommandText)
IF (@Debug = 1) PRINT CONCAT(OBJECT_NAME(@@PROCID), ':@SQL:', @SQL)
EXEC (@SQL)
GO

/*********************************************************************************************

    PROCEDURE LoggerBase.Logger_Base

    Date:           07/12/2017
    Author:         Jerome Pion
    Description:    A base logging SP that other level-specific loggers will use, e.g. Logger.Debug

    --TEST
	DECLARE @Config XML = 
'<log4mssql>
    <!-- A1 is set to be a ConsoleAppender -->
    <appender name="A1" type="LoggerBase.Appender_ConsoleAppender">
 
        <!-- A1 uses PatternLayout -->
        <layout type="LoggerBase.Layout_PatternLayout">
            <conversionPattern value="****TEST RESULT****%timestamp [%thread] %level %logger - %message" />
        </layout>
    </appender>
    
	<appender name="A2" type="LoggerBase.Appender_ConsoleAppender">
 
        <!-- A2 uses PatternLayout -->
        <layout type="LoggerBase.Layout_PatternLayout">
            <conversionPattern value="****TEST RESULT****%timestamp [%thread] %level %logger - %message" />
        </layout>
    </appender>

<appender name="MSSQLAppender" type="LoggerBase.Appender_MSSQLAppender">
    <commandText value="INSERT INTO LoggerBase.TestLog ([Date],[Thread],[Level],[Logger],[Message],[Exception]) VALUES (@log_date, @thread, @log_level, @logger, @message, @exception)" />
    <parameter>
        <parameterName value="@log_date" />
        <dbType value="DateTime" />
        <layout type="LoggerBase.Layout_RawTimeStampLayout" />
    </parameter>
    <parameter>
        <parameterName value="@thread" />
        <dbType value="varchar(255)" />
        <layout type="LoggerBase.Layout_PatternLayout">
            <conversionPattern value="%thread" />
        </layout>
    </parameter>
    <parameter>
        <parameterName value="@log_level" />
        <dbType value="varchar(50)" />
        <layout type="LoggerBase.Layout_PatternLayout">
            <conversionPattern value="%level" />
        </layout>
    </parameter>
    <parameter>
        <parameterName value="@logger" />
        <dbType value="varchar(255)" />
        <layout type="LoggerBase.Layout_PatternLayout">
            <conversionPattern value="%logger" />
        </layout>
    </parameter>
    <parameter>
        <parameterName value="@message" />
        <dbType value="varchar(4000)" />
        <layout type="LoggerBase.Layout_PatternLayout">
            <conversionPattern value="%message" />
        </layout>
    </parameter>
    <parameter>
        <parameterName value="@exception" />
        <dbType value="varchar(2000)" />
        <layout type="LoggerBase.Layout_PatternLayout" />
    </parameter>
</appender>

    <!-- Set root logger level to DEBUG and its only appenders to A1, A2, MSSQLAppender -->
    <root>
        <level value="DEBUG" />
        <appender-ref ref="A1" />
		<appender-ref ref="A2" />
    </root>

	<!--For the "TestProcedure" logger set the level of its "A2" appender to INFO -->
	<logger name="TestProcedure">
		<level value="INFO" />
		<appender-ref ref="A2" />
	</logger>
	<logger name="TestProcedure2">
		<level value="INFO" />
		<appender-ref ref="A2" />
	</logger>
</log4mssql>'

DECLARE @RequestedLogLevelName VARCHAR(100) = 'DEBUG'
DECLARE @LoggerName VARCHAR(500) = 'JustATestLogger'

EXEC LoggerBase.Logger_Base 
  @Message               = 'Some message.'
, @LoggerName            = @LoggerName
, @Config                = @Config
, @RequestedLogLevelName = 'DEBUG'
, @Debug                 = 1

EXEC LoggerBase.Logger_Base 
  @Message               = 'Some message.'
, @LoggerName            = 'DefaultConfigLogger'
, @RequestedLogLevelName = 'DEBUG'
, @Debug                 = 1

**********************************************************************************************/

CREATE PROCEDURE LoggerBase.Logger_Base 
(
	  @Message               VARCHAR(MAX)
	, @LoggerName            VARCHAR(500)
	, @Config                XML          = NULL
	, @StoredConfigName      VARCHAR(500) = NULL
	, @RequestedLogLevelName VARCHAR(100)
	, @Debug                 BIT = 0
)

AS

    SET NOCOUNT ON
	DECLARE @PrivateConfig XML
	EXEC LoggerBase.Config_Retrieve @Override = @Config, @Config = @PrivateConfig OUTPUT, @Debug = @Debug

	IF (@Debug = 1) PRINT CONCAT('[', OBJECT_NAME(@@PROCID), ']:@Config:', CONVERT(VARCHAR(MAX), @Config))

	DECLARE @Appenders TABLE
	(
		RowID INT
		,AppenderType SYSNAME
		,AppenderConfig XML
	)
	INSERT INTO @Appenders
	EXEC LoggerBase.Config_Appenders_FilteredByLevel
		 @Config                = @PrivateConfig           
		,@RequestedLogLevelName = @RequestedLogLevelName
		,@Debug                 = @Debug

	DECLARE @Counter INT
	DECLARE @Limit   INT
	DECLARE @SQL     NVARCHAR(MAX)
	DECLARE @AppenderConfig XML

	SELECT @Counter = MIN(RowID), @Limit = MAX(RowID)
	FROM @Appenders

	WHILE (@Counter <= @Limit)
	BEGIN
		SELECT @SQL = CONCAT(A.AppenderType, ' @LoggerName, @LogLevelName, @Message, @Config, @Debug')
		,@AppenderConfig = AppenderConfig
		FROM @Appenders A
		WHERE 1=1
		AND RowID = @Counter

		IF (@Debug = 1) PRINT CONCAT('[', OBJECT_NAME(@@PROCID), ']:@SQL:', @SQL)
		IF (@Debug = 1) PRINT CONCAT('[', OBJECT_NAME(@@PROCID), ']:@Message:', @Message)
		IF (@Debug = 1) PRINT CONCAT('[', OBJECT_NAME(@@PROCID), ']:@AppenderConfig:', CONVERT(VARCHAR(MAX), @AppenderConfig))

		EXECUTE sp_executesql @SQL, N'@LoggerName VARCHAR(500), @LogLevelName VARCHAR(500), @Message VARCHAR(MAX), @Config XML, @Debug BIT'
		, @LoggerName   = @LoggerName
		, @LogLevelName = @RequestedLogLevelName
		, @Message      = @Message
		, @Config       = @AppenderConfig
		, @Debug        = @Debug

		SET @Counter += 1

	END

GO

/*********************************************************************************************

    PROCEDURE Logger.Debug

    Date:           07/07/2017
    Author:         Jerome Pion
    Description:    Log a DEBUG level message.

    --TEST
	EXEC Logger.Debug 'A test debug message', 'Test Logger'
	EXEC Logger.Debug @Message = 'A test debug message', @LoggerName = 'Test Logger', @Debug = 1

	EXEC LoggerBase.Session_Level_Set 'DEBUG', @Debug = 1
	SELECT LoggerBase.Session_ContextID_Get()
	SELECT LoggerBase.Session_Level_Get()
	
	EXEC Logger.Debug 'A test debug message', 'Test Logger'
	EXEC Logger.Debug @Message = 'A test debug message', @LoggerName = 'Test Logger', @Debug = 1

**********************************************************************************************/

CREATE PROCEDURE Logger.Debug
(
	  @Message               VARCHAR(MAX)
	, @LoggerName            VARCHAR(500)
	, @Config                XML          = NULL
	, @StoredConfigName      VARCHAR(500) = NULL
	, @Debug                 BIT          = 0
)

AS

    SET NOCOUNT ON

	EXEC LoggerBase.Logger_Base 
	  @Message               = @Message
	, @LoggerName            = @LoggerName
	, @RequestedLogLevelName = 'DEBUG'
	, @Config                = @Config
	, @StoredConfigName      = @StoredConfigName
	, @Debug                 = @Debug

GO

/*********************************************************************************************

    PROCEDURE Logger.ERROR

    Date:           11/28/2017
    Author:         Jerome Pion
    Description:    Log a ERROR level message.

    --TEST
	EXEC Logger.ERROR 'A test ERROR message', 'Test Logger'
	EXEC Logger.ERROR @Message = 'A test ERROR message', @LoggerName = 'Test Logger', @DEBUG = 1

	EXEC LoggerBase.Session_Level_Set 'ERROR', @ERROR = 1
	SELECT LoggerBase.Session_ContextID_Get()
	SELECT LoggerBase.Session_Level_Get()
	
	EXEC Logger.ERROR 'A test ERROR message', 'Test Logger'
	EXEC Logger.ERROR @Message = 'A test ERROR message', @LoggerName = 'Test Logger', @DEBUG = 1

**********************************************************************************************/

CREATE PROCEDURE Logger.Error
(
	  @Message               VARCHAR(MAX)
	, @LoggerName            VARCHAR(500)
	, @Config                XML          = NULL
	, @StoredConfigName      VARCHAR(500) = NULL
	, @DEBUG                 BIT          = 0
)

AS

    SET NOCOUNT ON

	EXEC LoggerBase.Logger_Base 
	  @Message               = @Message
	, @LoggerName            = @LoggerName
	, @RequestedLogLevelName = 'ERROR'
	, @Config                = @Config
	, @StoredConfigName      = @StoredConfigName
	, @DEBUG                 = @DEBUG

GO

/*********************************************************************************************

    PROCEDURE Logger.Fatal

    Date:           11/28/2017
    Author:         Jerome Pion
    Description:    Log a Fatal level message.

    --TEST
	EXEC Logger.Fatal 'A test Fatal message', 'Test Logger'
	EXEC Logger.Fatal @Message = 'A test Fatal message', @LoggerName = 'Test Logger', @DEBUG = 1

	EXEC LoggerBase.Session_Level_Set 'Fatal', @Fatal = 1
	SELECT LoggerBase.Session_ContextID_Get()
	SELECT LoggerBase.Session_Level_Get()
	
	EXEC Logger.Fatal 'A test Fatal message', 'Test Logger'
	EXEC Logger.Fatal @Message = 'A test Fatal message', @LoggerName = 'Test Logger', @DEBUG = 1

**********************************************************************************************/

CREATE PROCEDURE Logger.Fatal
(
	  @Message               VARCHAR(MAX)
	, @LoggerName            VARCHAR(500)
	, @Config                XML          = NULL
	, @StoredConfigName      VARCHAR(500) = NULL
	, @DEBUG                 BIT          = 0
)

AS

    SET NOCOUNT ON

	EXEC LoggerBase.Logger_Base 
	  @Message               = @Message
	, @LoggerName            = @LoggerName
	, @RequestedLogLevelName = 'FATAL'
	, @Config                = @Config
	, @StoredConfigName      = @StoredConfigName
	, @DEBUG                 = @DEBUG

GO

/*********************************************************************************************

    PROCEDURE Logger.INFO

    Date:           11/28/2017
    Author:         Jerome Pion
    Description:    Log a INFO level message.

    --TEST
	EXEC Logger.INFO 'A test INFO message', 'Test Logger'
	EXEC Logger.INFO @Message = 'A test INFO message', @LoggerName = 'Test Logger', @DEBUG = 1

	EXEC LoggerBase.Session_Level_Set 'INFO', @INFO = 1
	SELECT LoggerBase.Session_ContextID_Get()
	SELECT LoggerBase.Session_Level_Get()
	
	EXEC Logger.INFO 'A test INFO message', 'Test Logger'
	EXEC Logger.INFO @Message = 'A test INFO message', @LoggerName = 'Test Logger', @DEBUG = 1

**********************************************************************************************/

CREATE PROCEDURE Logger.Info
(
	  @Message               VARCHAR(MAX)
	, @LoggerName            VARCHAR(500)
	, @Config                XML          = NULL
	, @StoredConfigName      VARCHAR(500) = NULL
	, @DEBUG                 BIT          = 0
)

AS

    SET NOCOUNT ON

	EXEC LoggerBase.Logger_Base 
	  @Message               = @Message
	, @LoggerName            = @LoggerName
	, @RequestedLogLevelName = 'INFO'
	, @Config                = @Config
	, @StoredConfigName      = @StoredConfigName
	, @DEBUG                 = @DEBUG

GO

/*********************************************************************************************

    PROCEDURE Logger.WARN

    Date:           11/28/2017
    Author:         Jerome Pion
    Description:    Log a WARN level message.

    --TEST
	EXEC Logger.WARN 'A test WARN message', 'Test Logger'
	EXEC Logger.WARN @Message = 'A test WARN message', @LoggerName = 'Test Logger', @DEBUG = 1

	EXEC LoggerBase.Session_Level_Set 'WARN', @WARN = 1
	SELECT LoggerBase.Session_ContextID_Get()
	SELECT LoggerBase.Session_Level_Get()
	
	EXEC Logger.WARN 'A test WARN message', 'Test Logger'
	EXEC Logger.WARN @Message = 'A test WARN message', @LoggerName = 'Test Logger', @DEBUG = 1

**********************************************************************************************/

CREATE PROCEDURE Logger.Warn
(
	  @Message               VARCHAR(MAX)
	, @LoggerName            VARCHAR(500)
	, @Config                XML          = NULL
	, @StoredConfigName      VARCHAR(500) = NULL
	, @DEBUG                 BIT          = 0
)

AS

    SET NOCOUNT ON

	EXEC LoggerBase.Logger_Base 
	  @Message               = @Message
	, @LoggerName            = @LoggerName
	, @RequestedLogLevelName = 'WARN'
	, @Config                = @Config
	, @StoredConfigName      = @StoredConfigName
	, @DEBUG                 = @DEBUG

GO
RAISERROR('',0,1)WITH NOWAIT;
RAISERROR('+-----------------------------------------+',0,1)WITH NOWAIT;
RAISERROR('|                                         |',0,1)WITH NOWAIT;
RAISERROR('| log4mssql installation complete         |',0,1)WITH NOWAIT;
RAISERROR('|                                         |',0,1)WITH NOWAIT;
RAISERROR('+-----------------------------------------+',0,1)WITH NOWAIT;
GO
